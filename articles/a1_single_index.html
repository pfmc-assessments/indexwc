<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coastwide indices • indexwc</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Coastwide indices">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">indexwc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.8</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/a1_single_index.html">Coastwide indices</a>
    </li>
    <li>
      <a href="../articles/a2_multiple_area_indices.html">Index example with multiple areas</a>
    </li>
    <li>
      <a href="../articles/configuration.html">Configuration File</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/pfmc-assessments/indexwc/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Coastwide indices</h1>
            
            <h4 data-toc-skip class="date">2025-12-19</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/pfmc-assessments/indexwc/blob/main/vignettes/a1_single_index.Rmd" class="external-link"><code>vignettes/a1_single_index.Rmd</code></a></small>
      <div class="hidden name"><code>a1_single_index.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>This vignette highlights the ability to generate coastwide indices
for stocks using the <code>indexwc</code> package.</p>
</div>
<div class="section level2">
<h2 id="yellowtail-rockfish-example">Yellowtail rockfish example<a class="anchor" aria-label="anchor" href="#yellowtail-rockfish-example"></a>
</h2>
<p>As a case study, we’ll focus on yellowtail rockfish</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/pfmc-assessments/indexwc" class="external-link">indexwc</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sdmTMB.github.io/sdmTMB/" class="external-link">sdmTMB</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span></code></pre></div>
<p>First we’ll load in the configuration file. This is bringing in
specific settings by survey and species that are used to subset the data
and define the parameterization of the index estimation. This file is
included as both an <code>rda</code> file that is loaded with the
package but is also available for users who download the source code in
the <code>data-raw</code> folder (download the package to see this).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load from the rda file</span></span>
<span><span class="va">configuration_ytk</span> <span class="op">&lt;-</span> <span class="va">configuration</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="st">"yellowtail rockfish"</span><span class="op">)</span></span></code></pre></div>
<p>The configuration file contains settings you may wish to change,
including attributes of filters (years, latitudes, depths), and model
components (anisotropy, knots, spatiotemporal effects, etc).</p>
<p>The configuration includes multiple entries for a single species for
separate surveys and error distributions (e.g., delta-lognormal,
delta-gamma, etc.).</p>
<p>In this example, we are going to only run a single-index for the
Northwest Fisheries Science Center (NWFSC) West Coast Groundfish Bottom
Trawl (WCGBT) survey (i.e., also referred to as the NWFSC.Combo survey
in the data NWFSC data warehouse).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">configuration_ytk_wcgbt</span> <span class="op">&lt;-</span> <span class="va">configuration_ytk</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">source</span> <span class="op">==</span> <span class="st">"NWFSC.Combo"</span> <span class="op">&amp;</span> <span class="va">family</span> <span class="op">==</span> <span class="st">"sdmTMB::delta_gamma()"</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="statistical-model">Statistical model<a class="anchor" aria-label="anchor" href="#statistical-model"></a>
</h3>
<p>For most indices developed on the west coast of the USA, the main
formula is usually something similar to the following, where
<code>fyear</code> represents a fixed year effect, and
<code>pass_scaled</code> is factor describing whether the haul is part
of pass 1 (early season) or pass 2 (late season).</p>
<p>There are two unique index formula’s available for yellowtail
rockfish:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">configuration_ytk_wcgbt</span><span class="op">[</span>, <span class="st">"formula"</span><span class="op">]</span></span></code></pre></div>
<p>we are going to use the default configuration. Please see the
vignette on multiple area indices for an example run with the other
formulation available for yellowtail rockfish.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">configuration_to_run</span> <span class="op">&lt;-</span> <span class="va">configuration_ytk_wcgbt</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">formula</span> <span class="op">==</span> <span class="st">"catch_weight ~ 0 + fyear + pass_scaled"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="preparing-the-data">Preparing the data<a class="anchor" aria-label="anchor" href="#preparing-the-data"></a>
</h3>
<p>This block pulls trawl survey from the NWFSC data warehouse and
applies filters (based on latitude, depth, and year) to each
observation.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">configuration_to_run</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    data_raw <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/format_data.html">format_data</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">fxn</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    data_filtered <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">data_raw</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>        <span class="va">depth</span> <span class="op">&lt;=</span> <span class="va">min_depth</span>, <span class="va">depth</span> <span class="op">&gt;=</span> <span class="va">max_depth</span>,</span>
<span>        <span class="va">latitude</span> <span class="op">&gt;=</span> <span class="va">min_latitude</span>, <span class="va">latitude</span> <span class="op">&lt;=</span> <span class="va">max_latitude</span>,</span>
<span>        <span class="va">year</span> <span class="op">&gt;=</span> <span class="va">min_year</span>, <span class="va">year</span> <span class="op">&lt;=</span> <span class="va">max_year</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The filtered data that will be used in the model can be viewed by
examining <code>data$data_filtered[1]</code>.</p>
</div>
<div class="section level3">
<h3 id="fitting-the-model-with-indexwc-and-sdmtmb">Fitting the model with indexwc and sdmTMB<a class="anchor" aria-label="anchor" href="#fitting-the-model-with-indexwc-and-sdmtmb"></a>
</h3>
<p>Now we can use the <code>indexwc</code> package to fit the model. The
<code>indexwc</code> package acts as a wrapper for <code>sdmTMB</code>
here, combining the estimation process (<code><a href="https://sdmTMB.github.io/sdmTMB/reference/sdmTMB.html" class="external-link">sdmTMB()</a></code>) with the
index generation (<code><a href="https://sdmTMB.github.io/sdmTMB/reference/get_index.html" class="external-link">get_index()</a></code>).</p>
<p>This code is optimized to fit multiple models (across stocks /
species, or model configurations). In our case, the configurations
dataframe has 1 row – but this could include multiple rows. A key point
to highlight is that in this code, we use <code><a href="https://sdmTMB.github.io/sdmTMB/reference/sdmTMBcontrol.html" class="external-link">sdmTMBcontrol()</a></code>
to pass in a list that contains the variables above we use to map off
and initialize the parameters. For datasets without missing values, you
may not want to include this <code><a href="https://sdmTMB.github.io/sdmTMB/reference/sdmTMBcontrol.html" class="external-link">sdmTMBcontrol()</a></code> line, but it
may be useful to adjust the <code>newton_loops</code>, etc.</p>
<p>Note: this code will fit a single model for each row</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">best</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># Evaluate the call in family</span></span>
<span>    family <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">family</span>, .f <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="co"># Run the model on each row in data</span></span>
<span>    results <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap</a></span><span class="op">(</span></span>
<span>      .l <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">data_filtered</span>,</span>
<span>        formula <span class="op">=</span> <span class="va">formula</span>,</span>
<span>        family <span class="op">=</span> <span class="va">family</span>,</span>
<span>        anisotropy <span class="op">=</span> <span class="va">anisotropy</span>,</span>
<span>        n_knots <span class="op">=</span> <span class="va">knots</span>,</span>
<span>        share_range <span class="op">=</span> <span class="va">share_range</span>,</span>
<span>        spatiotemporal <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2</a></span><span class="op">(</span><span class="va">spatiotemporal1</span>, <span class="va">spatiotemporal2</span>, <span class="va">list</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      .f <span class="op">=</span> <span class="fu">indexwc</span><span class="fu">::</span><span class="va"><a href="../reference/run_sdmtmb.html">run_sdmtmb</a></span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>The above script saves the model run in the working directory. If you
would like to save the output to a different location, the
<code>dir_main</code> argument should be specified in the list passed to
the function.</p>
</div>
<div class="section level3">
<h3 id="examining-the-index-and-diagnostics">Examining the index and diagnostics<a class="anchor" aria-label="anchor" href="#examining-the-index-and-diagnostics"></a>
</h3>
<p>Output and diagnostics for all models and predictions are stored in a
folder that <code>indexwc</code> creates; it’s location is
“yellowtail_rockfish/wcgbts/delta_gamma..”. The “data” folder contains
the raw data used for estimation (<code>data.rdata</code>) and a plot of
the SPDE mesh is in <code>mesh.png</code>. The “index” folder contains
diagnostics and predictions for 10 sets of indices. These 10 indices
represent (1) N/S of Cape Mendocino, (2) N/S of Monterrey, (3) N/S of Pt
Conception, a coastwide index, and state-specific indices. Plots
include:</p>
<ul>
<li><p>density plots (<code>density01.png</code>,
<code>density02.png</code>, …) which represent predictions for pairs of
years</p></li>
<li><p>a coastwide index (<code>index_coastwide.png</code>)</p></li>
<li><p>fixed effect parameters
(<code>parameters_fixed_effects.png</code>)</p></li>
<li><p>QQ plot (<code>qq.png</code>)</p></li>
<li><p>anisotropy plot of the presence/absence and catch rate models for
the spatial and spatiotemporal fields
(<code>anisotropy.png</code>)</p></li>
<li><p>residual plots (<code>residuals_1_01.png</code>,
<code>residuals_1_02.png</code>, …, <code>residuals_2_01.png</code>,
<code>residuals_2_02.png</code>,…) where pairs of years are shown, and
separate residual plots are made for the presence-absence and positive
model components</p></li>
</ul>
<p>Additional output includes:</p>
<ul>
<li><p>indices generated by area (<code>est_by_area.csv</code>), the
<code>year</code>, <code>est</code>, and <code>se</code> columns are the
needed inputs for SS3 filtered down to the appropriate area</p></li>
<li><p>the dataframe of <code><a href="https://sdmTMB.github.io/sdmTMB/reference/sanity.html" class="external-link">sdmTMB::sanity()</a></code> checks (in
<code>sanity_data_frame.csv</code>)</p></li>
<li><p>text file with the AIC and NLL
(<code>aic_nll.txt</code>)</p></li>
<li><p>text file with TRUE/FALSE for the hessian
(<code>hess_logical.txt</code>)</p></li>
<li><p>Rdata file with model fits, all data objects, and parameter
estimates (<code>sdmTMB_save.Rdata</code>)</p></li>
<li><p>Rdata file with model predictions
(<code>predictions.Rdata</code>)</p></li>
</ul>
<p>If all the diagnostic plots are not created, this often means that
parameter warnings were generated during the model fitting. To see what
those warnings, the <code>ignore_fit.rds</code> file can be loaded into
R and calling <code>sdmTMB::sanity(fit)</code> will output the parameter
warnings.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Kelli F. Johnson, Sean C. Anderson, Chantel R. Wetzel, Eric J. Ward, Ian G. Taylor.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
