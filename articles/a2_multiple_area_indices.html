<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Index example with multiple areas • indexwc</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Index example with multiple areas">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">indexwc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.7</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/a1_single_index.html">Coastwide indices</a>
    </li>
    <li>
      <a href="../articles/a2_multiple_area_indices.html">Index example with multiple areas</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Index example with multiple areas</h1>
            
            <h4 data-toc-skip class="date">2025-01-25</h4>
      

      <div class="hidden name"><code>a2_multiple_area_indices.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>For some stocks, a goal might be to create multiple coastwide
indices, where these indices are defined by latitudinal breaks. This
vignette highlights the ability to fit these models using the
<code>indexwc</code> package, and how to deal with sparse or missing
observations</p>
</div>
<div class="section level2">
<h2 id="yellowtail-rockfish-example">Yellowtail rockfish example<a class="anchor" aria-label="anchor" href="#yellowtail-rockfish-example"></a>
</h2>
<p>As a multi-area index example, we’ll focus on yellowtail rockfish</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">indexwc</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pbs-assess.github.io/sdmTMB/" class="external-link">sdmTMB</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span></code></pre></div>
<p>First we’ll load in the configuration file. This is bringing in
specific settings by survey and species that are used to subset the data
and define the parameterization of the index estimation. This file is
included as both an <code>rda</code> file that is loaded with the
package but is also available for users who download the source code in
the <code>data-raw</code> folder (download the package to see this).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load from the rda file</span></span>
<span><span class="va">configuration_ytk</span> <span class="op">&lt;-</span> <span class="va">configuration</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="st">"yellowtail rockfish"</span><span class="op">)</span></span></code></pre></div>
<p>The configuration file contains settings you may wish to change,
including attributes of filters (years, latitudes, depths), and model
components (anisotropy, knots, spatiotemporal effects, etc).</p>
<p>The configuration includes multiple entries for a single species for
separate surveys and error distributions (e.g., delta-lognormal,
delta-gamma, etc.).</p>
<p>In this example, we are going to only run a single-index for the
Northwest Fisheries Science Center (NWFSC) West Coast Groundfish Bottom
Trawl (WCGBT) survey (i.e., also referred to as the NWFSC.Combo survey
in the data NWFSC data warehouse).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">configuration_ytk_wcgbt</span> <span class="op">&lt;-</span> <span class="va">configuration_ytk</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">source</span> <span class="op">==</span> <span class="st">"NWFSC.Combo"</span> <span class="op">&amp;</span> <span class="va">family</span> <span class="op">==</span> <span class="st">"sdmTMB::delta_gamma()"</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="statistical-model">Statistical model<a class="anchor" aria-label="anchor" href="#statistical-model"></a>
</h3>
<p>For most indices developed on the west coast of the USA, the main
formula is usually something similar to the following, where
<code>fyear</code> represents a fixed year effect, and
<code>pass_scaled</code> is factor describing whether the haul is part
of pass 1 (early season) or pass 2 (late season). There are two unique
index formula’s available for yellowtail rockfish:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">configuration_ytk_wcgbt</span><span class="op">[</span>, <span class="st">"formula"</span><span class="op">]</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 1</span></span></span>
<span><span class="co">#&gt;   formula                                               </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                                                 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> catch_weight ~ 0 + fyear*split_mendocino + pass_scaled</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> catch_weight ~ 0 + fyear + pass_scaled</span></span></code></pre></div>
<p>we are going to use the formula with an area based term. Please see
the vignette on single area indices for an example run with the other
formulation available for yellowtail rockfish.</p>
<p>There are many ways to build on this general framework to allow for
multi-area indices. For yellowtail rockfish, we’re going to generate 2
indices, north and south of Cape Mendocino. Including the interaction
<code>fyear*split_mendocino</code> allows each region to have a separate
trend, and because no interaction is included with
<code>pass_scaled</code>, a global effect is assumed.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">configuration_to_run</span> <span class="op">&lt;-</span> <span class="va">configuration_ytk_wcgbt</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">formula</span> <span class="op">==</span> <span class="st">"catch_weight ~ 0 + fyear*split_mendocino + pass_scaled"</span><span class="op">)</span></span></code></pre></div>
<p>As a quick aside, the <code>indexwc</code> package allows for other
spatial splits, and in implementing them, the choice of names must be
consistent with those used in the package (and specifically in the
prediction grid). Variables currently included are: *
<code>split_mendocino</code> representing a split N/S of 40.167 degrees
* <code>split_conception</code> representing a split N/S of 34.45
degrees * <code>split_monterey</code> representing a split N/S of 36
degrees * <code>split_state</code> representing three splits for
California, Oregon, Washington</p>
<p>Generating new variables representing new splits will allow you to
fit models with <code>sdmTMB</code>, but the predictions (index) will
fail – for these cases, a better solution is to request additional
splits be added to the package.</p>
</div>
<div class="section level3">
<h3 id="preparing-the-data">Preparing the data<a class="anchor" aria-label="anchor" href="#preparing-the-data"></a>
</h3>
<p>This block applies filters (based on latitude, depth, and year) to
each observation, and creates the new variable
<code>split_mendocino</code> that already exists in the prediction
dataframe.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">configuration_to_run</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Row by row ... do stuff then ungroup</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Pull the data based on the function found in fxn column</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    data_raw <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/format_data.html">format_data</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">fxn</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    data_filtered <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">data_raw</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>        <span class="va">depth</span> <span class="op">&lt;=</span> <span class="va">min_depth</span>, <span class="va">depth</span> <span class="op">&gt;=</span> <span class="va">max_depth</span>,</span>
<span>        <span class="va">latitude</span> <span class="op">&gt;=</span> <span class="va">min_latitude</span>, <span class="va">latitude</span> <span class="op">&lt;=</span> <span class="va">max_latitude</span>,</span>
<span>        <span class="va">year</span> <span class="op">&gt;=</span> <span class="va">min_year</span>, <span class="va">year</span> <span class="op">&lt;=</span> <span class="va">max_year</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>split_mendocino <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">latitude</span> <span class="op">&gt;</span> <span class="fl">40.1666667</span>, <span class="st">"N"</span>, <span class="st">"S"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Yellowtail rockfish occur more north of Cape Mendocino, and as a
check we can see if there’s any years with no positive catches. This
filtering shows that no positive catches exist for 2007.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">data_filtered</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">split_mendocino</span>, <span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>sum_catch_weight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">catch_weight</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sum_catch_weight</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 3</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Groups:   split_mendocino [1]</span></span></span>
<span><span class="co">#&gt;   split_mendocino  year sum_catch_weight</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> S                <span style="text-decoration: underline;">2</span>007                0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> S                <span style="text-decoration: underline;">2</span>024                0</span></span></code></pre></div>
<p>This is a problem because if we try to estimate the
<code>fyear:split_mendocino</code> interaction, the coefficient will not
be identifiable for 2007. This is not a unique problem for
<code>sdmTMB</code> but a general issue for any regression / GLM / GAM /
GLMM model. The workaround that we’ll implement is to “map off” or not
estimate the <code>fyear:split_mendocino</code> in 2007 – but estimate
it in all other years.</p>
<p>As a first step, we’ll summarize the names of all main effect
coefficients in our model. We use <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> to do this for
simplicity, but other approaches could also be used.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="va">configuration_to_run</span><span class="op">$</span><span class="va">formula</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">data_filtered</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">coef_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">lm</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">coef_names</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "fyear2003"                  "fyear2004"                 </span></span>
<span><span class="co">#&gt;  [3] "fyear2005"                  "fyear2006"                 </span></span>
<span><span class="co">#&gt;  [5] "fyear2007"                  "fyear2008"                 </span></span>
<span><span class="co">#&gt;  [7] "fyear2009"                  "fyear2010"                 </span></span>
<span><span class="co">#&gt;  [9] "fyear2011"                  "fyear2012"                 </span></span>
<span><span class="co">#&gt; [11] "fyear2013"                  "fyear2014"                 </span></span>
<span><span class="co">#&gt; [13] "fyear2015"                  "fyear2016"                 </span></span>
<span><span class="co">#&gt; [15] "fyear2017"                  "fyear2018"                 </span></span>
<span><span class="co">#&gt; [17] "fyear2019"                  "fyear2021"                 </span></span>
<span><span class="co">#&gt; [19] "fyear2022"                  "fyear2023"                 </span></span>
<span><span class="co">#&gt; [21] "fyear2024"                  "split_mendocinoS"          </span></span>
<span><span class="co">#&gt; [23] "pass_scaled"                "fyear2004:split_mendocinoS"</span></span>
<span><span class="co">#&gt; [25] "fyear2005:split_mendocinoS" "fyear2006:split_mendocinoS"</span></span>
<span><span class="co">#&gt; [27] "fyear2007:split_mendocinoS" "fyear2008:split_mendocinoS"</span></span>
<span><span class="co">#&gt; [29] "fyear2009:split_mendocinoS" "fyear2010:split_mendocinoS"</span></span>
<span><span class="co">#&gt; [31] "fyear2011:split_mendocinoS" "fyear2012:split_mendocinoS"</span></span>
<span><span class="co">#&gt; [33] "fyear2013:split_mendocinoS" "fyear2014:split_mendocinoS"</span></span>
<span><span class="co">#&gt; [35] "fyear2015:split_mendocinoS" "fyear2016:split_mendocinoS"</span></span>
<span><span class="co">#&gt; [37] "fyear2017:split_mendocinoS" "fyear2018:split_mendocinoS"</span></span>
<span><span class="co">#&gt; [39] "fyear2019:split_mendocinoS" "fyear2021:split_mendocinoS"</span></span>
<span><span class="co">#&gt; [41] "fyear2022:split_mendocinoS" "fyear2023:split_mendocinoS"</span></span>
<span><span class="co">#&gt; [43] "fyear2024:split_mendocinoS"</span></span></code></pre></div>
<p>All of the coefficients from the presence - absence model look to be
identifiable</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pres_not_identifiable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">lm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">pres_not_identifiable</span><span class="op">)</span></span>
<span><span class="co">#&gt; character(0)</span></span></code></pre></div>
<p>To identify the labels of the coefficients from the positive model
that are not estimable, we can re-fit the regression, using only
positive observations.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lm_pos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="va">configuration_to_run</span><span class="op">$</span><span class="va">formula</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">data_filtered</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">catch_weight</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">pos_not_identifiable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">lm_pos</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">pos_not_identifiable</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "fyear2007:split_mendocinoS" "fyear2024:split_mendocinoS"</span></span></code></pre></div>
<p>Finally, we can create some mapping variables to be passed to
<code>sdmTMB</code>. We’ll do this separately for the presence-absence
and positive models.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">map_pres</span> <span class="op">&lt;-</span> <span class="va">coef_names</span></span>
<span><span class="va">map_pres</span><span class="op">[</span><span class="va">coef_names</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">pres_not_identifiable</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">map_pres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">map_pres</span><span class="op">)</span></span>
<span></span>
<span><span class="va">map_pos</span> <span class="op">&lt;-</span> <span class="va">coef_names</span></span>
<span><span class="va">map_pos</span><span class="op">[</span><span class="va">coef_names</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">pos_not_identifiable</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">map_pos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">map_pos</span><span class="op">)</span></span></code></pre></div>
<p>Along with these mapping vectors, we’ll create vectors of starting
values (arbitrarily assigning -20 to values that are not estimable)</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">start_pres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">coef_names</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">start_pres</span><span class="op">[</span><span class="va">coef_names</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">pres_not_identifiable</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">20</span></span>
<span></span>
<span><span class="va">start_pos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">coef_names</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">start_pos</span><span class="op">[</span><span class="va">coef_names</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">pos_not_identifiable</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">20</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fitting-the-model-with-indexwc-and-sdmtmb">Fitting the model with indexwc and sdmTMB<a class="anchor" aria-label="anchor" href="#fitting-the-model-with-indexwc-and-sdmtmb"></a>
</h3>
<p>Now we can use the <code>indexwc</code> package to fit the model. The
<code>indexwc</code> package acts as a wrapper for <code>sdmTMB</code>
here, combining the estimation process (<code><a href="https://pbs-assess.github.io/sdmTMB/reference/sdmTMB.html" class="external-link">sdmTMB()</a></code>) with the
index generation (<code><a href="https://pbs-assess.github.io/sdmTMB/reference/get_index.html" class="external-link">get_index()</a></code>).</p>
<p>This code is optimized to fit multiple models (across stocks /
species, or model configurations). In our case, the configurations
dataframe has 1 row – but this could include multiple rows. A key point
to highlight is that in this code, we use <code><a href="https://pbs-assess.github.io/sdmTMB/reference/sdmTMBcontrol.html" class="external-link">sdmTMBcontrol()</a></code>
to pass in a list that contains the variables above we use to map off
and initialize the parameters. For datasets without missing values, you
may not want to include this <code><a href="https://pbs-assess.github.io/sdmTMB/reference/sdmTMBcontrol.html" class="external-link">sdmTMBcontrol()</a></code> line, but it
may be useful to adjust the <code>newton_loops</code>, etc.</p>
<p>Note: this code will fit a single model for each row.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">best</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># Evaluate the call in family</span></span>
<span>    family <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">family</span>, .f <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="co"># Run the model on each row in data</span></span>
<span>    results <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap</a></span><span class="op">(</span></span>
<span>      .l <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">data_filtered</span>,</span>
<span>        formula <span class="op">=</span> <span class="va">formula</span>,</span>
<span>        family <span class="op">=</span> <span class="va">family</span>,</span>
<span>        anisotropy <span class="op">=</span> <span class="va">anisotropy</span>,</span>
<span>        n_knots <span class="op">=</span> <span class="va">knots</span>,</span>
<span>        share_range <span class="op">=</span> <span class="va">share_range</span>,</span>
<span>        spatiotemporal <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2</a></span><span class="op">(</span><span class="va">spatiotemporal1</span>, <span class="va">spatiotemporal2</span>, <span class="va">list</span><span class="op">)</span>,</span>
<span>        sdmtmb_control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          <span class="fu">sdmTMB</span><span class="fu">::</span><span class="fu"><a href="https://pbs-assess.github.io/sdmTMB/reference/sdmTMBcontrol.html" class="external-link">sdmTMBcontrol</a></span><span class="op">(</span></span>
<span>            map <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>b_j <span class="op">=</span> <span class="va">map_pos</span>, b_j2 <span class="op">=</span> <span class="va">map_pos</span><span class="op">)</span>,</span>
<span>            start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>b_j <span class="op">=</span> <span class="va">start_pos</span>, b_j2 <span class="op">=</span> <span class="va">start_pos</span><span class="op">)</span>,</span>
<span>            newton_loops <span class="op">=</span> <span class="fl">1</span> <span class="co"># increase for real models</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      .f <span class="op">=</span> <span class="fu">indexwc</span><span class="fu">::</span><span class="va"><a href="../reference/run_sdmtmb.html">run_sdmtmb</a></span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="examining-the-index-and-diagnostics">Examining the index and diagnostics<a class="anchor" aria-label="anchor" href="#examining-the-index-and-diagnostics"></a>
</h3>
<p>Output and diagnostics for all models and predictions are stored in a
folder that <code>indexwc</code> creates; it’s location is
“yellowtail_rockfish/wcgbts/delta_gamma..”. The “index” folder contains
diagnostics and predictions for 10 sets of indices. These 10 indices
represent (1) N/S of Cape Mendocino, (2) N/S of Monterrey, (3) N/S of Pt
Conception, a coastwide index, and state-specific indices. For
multi-region models, like the yellowtail rockfish used here, it wouldn’t
make sense to interpret indices other than the split used in the model
(here, N/S of Cape Mendocino) and the coastwide index.</p>
<p><img src="..%2F..%2F..%2F_temp%2FLibrary%2Findexwc%2Fall_yellowtail_indices.png"><!-- --></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Kelli F. Johnson, Sean C. Anderson, Chantel R. Wetzel, Eric J. Ward, Ian G. Taylor.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
